<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QuickSort Visualizer</title>
  <meta name="description" content="ã‚¯ã‚¤ãƒƒã‚¯ã‚½ãƒ¼ãƒˆã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’è¦–è¦šçš„ã«ç†è§£ã§ãã‚‹ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªå¯è¦–åŒ–ãƒ„ãƒ¼ãƒ«">
  <style>
    /* CSSå¤‰æ•°å®šç¾© */
    :root {
      /* ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒ */
      --bg-dark: #0a0e1a;
      --panel-dark: #151922;
      --border-dark: #1f2937;
      --text-dark: #e5e7eb;
      --muted-dark: #9ca3af;

      /* ãƒ©ã‚¤ãƒˆãƒ†ãƒ¼ãƒ */
      --bg-light: #f8fafc;
      --panel-light: #ffffff;
      --border-light: #e2e8f0;
      --text-light: #1e293b;
      --muted-light: #64748b;

      /* æ£’ã‚°ãƒ©ãƒ•ã®è‰²ï¼ˆçŠ¶æ…‹åˆ¥ï¼‰ */
      --bar-default: #3b82f6;    /* é’ - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ */
      --bar-pivot: #f59e0b;      /* ã‚ªãƒ¬ãƒ³ã‚¸ - ãƒ”ãƒœãƒƒãƒˆ */
      --bar-comparing: #8b5cf6;  /* ç´« - æ¯”è¼ƒä¸­ */
      --bar-swapping: #ef4444;   /* èµ¤ - ã‚¹ãƒ¯ãƒƒãƒ—ä¸­ */
      --bar-sorted: #10b981;     /* ç·‘ - ã‚½ãƒ¼ãƒˆæ¸ˆã¿ */

      /* ã‚¢ã‚¯ã‚»ãƒ³ãƒˆã‚«ãƒ©ãƒ¼ */
      --accent-primary: #06b6d4;
      --accent-secondary: #a78bfa;

      /* ã‚·ãƒ£ãƒ‰ã‚¦ */
      --shadow: 0 10px 30px rgba(0, 0, 0, 0.35);

      color-scheme: dark;
    }

    /* ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ */
    body.light {
      --bg: var(--bg-light);
      --panel: var(--panel-light);
      --border: var(--border-light);
      --text: var(--text-light);
      --muted: var(--muted-light);
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      color-scheme: light;
    }

    /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ */
    body, body.dark {
      --bg: var(--bg-dark);
      --panel: var(--panel-dark);
      --border: var(--border-dark);
      --text: var(--text-dark);
      --muted: var(--muted-dark);
    }

    /* åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }

    body {
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      display: grid;
      grid-template-rows: auto 1fr auto;
      min-height: 100vh;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 18px clamp(16px, 4vw, 28px);
      background: var(--panel);
      border-bottom: 1px solid var(--border);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 800;
      font-size: 1.25rem;
      letter-spacing: 0.5px;
    }

    .brand .logo {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      background: linear-gradient(135deg, var(--bar-pivot), var(--bar-swapping));
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
    }

    .theme-toggle {
      background: var(--panel);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 12px;
      cursor: pointer;
      transition: transform 0.06s ease, background 0.2s ease;
      font-size: 1.25rem;
    }

    .theme-toggle:hover {
      background: var(--border);
    }

    .theme-toggle:active {
      transform: scale(0.95);
    }

    /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
    main {
      padding: 20px clamp(16px, 4vw, 28px);
      overflow-y: auto;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      display: grid;
      gap: 20px;
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      box-shadow: var(--shadow);
    }

    .card-title {
      font-size: 1.125rem;
      font-weight: 700;
      margin-bottom: 16px;
      color: var(--text);
    }

    /* ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼ */
    .visualizer-container {
      min-height: 400px;
    }

    .operation-display {
      text-align: center;
      padding: 16px;
      background: rgba(59, 130, 246, 0.1);
      border-radius: 12px;
      margin-bottom: 20px;
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .operation-display p {
      margin: 0;
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text);
    }

    .empty-message {
      color: var(--muted);
      font-size: 1rem;
    }

    /* æ£’ã‚°ãƒ©ãƒ• */
    .bar-chart {
      display: flex;
      align-items: flex-end;
      gap: 2px;
      height: 300px;
      padding: 10px;
      background: linear-gradient(to bottom, rgba(0,0,0,0.1), transparent);
      border-radius: 12px;
    }

    .bar {
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      align-items: center;
      min-width: 8px;
      border-radius: 4px 4px 0 0;
      transition: height 0.3s ease, background-color 0.2s ease, transform 0.2s ease;
      will-change: height, background-color;
    }

    .bar-value {
      position: absolute;
      top: -20px;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text);
      opacity: 0.8;
    }

    /* æ£’ã®è‰²åˆ†ã‘ */
    .bar-default {
      background: var(--bar-default);
    }

    .bar-pivot {
      background: var(--bar-pivot);
      box-shadow: 0 0 20px rgba(245, 158, 11, 0.5);
      animation: pivot-glow 1s ease-in-out infinite;
    }

    .bar-comparing {
      background: var(--bar-comparing);
      animation: compare-blink 0.8s ease-in-out;
    }

    .bar-swapping {
      background: var(--bar-swapping);
      animation: swap-pulse 0.6s ease-in-out;
    }

    .bar-sorted {
      background: var(--bar-sorted);
      animation: sorted-celebrate 0.5s ease-out;
    }

    /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    @keyframes pivot-glow {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    @keyframes compare-blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    @keyframes swap-pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); filter: brightness(1.2); }
    }

    @keyframes sorted-celebrate {
      0% { transform: translateY(0); }
      30% { transform: translateY(-10px); }
      100% { transform: translateY(0); }
    }

    /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« */
    .controls-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }

    .control-group {
      margin-bottom: 16px;
    }

    .control-group:last-child {
      margin-bottom: 0;
    }

    .control-label {
      display: block;
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 8px;
    }

    .control-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 16px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      background: var(--panel);
      color: var(--text);
      border: 1px solid var(--border);
      padding: 10px 14px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1.125rem;
      transition: transform 0.06s ease, background 0.2s ease, border-color 0.2s ease;
      user-select: none;
      min-width: 44px;
    }

    .btn:hover:not(:disabled) {
      background: var(--border);
      border-color: var(--accent-primary);
    }

    .btn:active:not(:disabled) {
      transform: translateY(1px) scale(0.98);
    }

    .btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .btn.primary {
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      color: white;
      border-color: transparent;
      box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3);
    }

    .btn.primary:hover:not(:disabled) {
      filter: brightness(1.1);
    }

    /* ã‚·ãƒ¼ã‚¯ãƒãƒ¼ */
    .seek-bar {
      margin: 16px 0;
    }

    .seek-bar input[type="range"] {
      width: 100%;
    }

    .step-counter {
      display: block;
      text-align: center;
      margin-top: 8px;
      font-size: 0.875rem;
      color: var(--muted);
    }

    /* å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ */
    input[type="range"] {
      width: 100%;
      height: 8px;
      background: var(--border);
      border-radius: 4px;
      outline: none;
      -webkit-appearance: none;
      appearance: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      background: var(--accent-primary);
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    }

    input[type="range"]::-moz-range-thumb {
      width: 18px;
      height: 18px;
      background: var(--accent-primary);
      border-radius: 50%;
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    }

    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      padding: 10px 12px;
      background: var(--bg);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 0.9375rem;
      transition: border-color 0.2s ease;
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    select:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
    }

    .range-display {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .range-value {
      font-weight: 700;
      color: var(--accent-primary);
    }

    .hint {
      font-size: 0.75rem;
      color: var(--muted);
      margin-top: 6px;
    }

    /* ãƒ•ãƒƒã‚¿ãƒ¼ */
    footer {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 24px;
      padding: 16px;
      background: var(--panel);
      border-top: 1px solid var(--border);
      font-size: 0.875rem;
      color: var(--muted);
      flex-wrap: wrap;
    }

    .stat-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .stat-label {
      font-weight: 600;
    }

    .stat-value {
      font-weight: 700;
      color: var(--accent-primary);
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    @media (max-width: 768px) {
      .controls-grid {
        grid-template-columns: 1fr;
      }

      .control-buttons {
        justify-content: center;
      }

      .bar-value {
        font-size: 0.625rem;
        top: -16px;
      }

      footer {
        font-size: 0.75rem;
        gap: 12px;
      }
    }
  </style>
</head>
<body class="dark">
  <div id="root"></div>

  <!-- React CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useCallback, useMemo } = React;

    // ========================================
    // ã‚¯ã‚¤ãƒƒã‚¯ã‚½ãƒ¼ãƒˆã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã¨ã‚¹ãƒ†ãƒƒãƒ—ç”Ÿæˆ
    // ========================================

    /**
     * ã‚¯ã‚¤ãƒƒã‚¯ã‚½ãƒ¼ãƒˆã®å…¨ã‚¹ãƒ†ãƒƒãƒ—ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
     * @param {number[]} arr - ã‚½ãƒ¼ãƒˆå¯¾è±¡ã®é…åˆ—
     * @returns {Array} ã‚¹ãƒ†ãƒƒãƒ—ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é…åˆ—
     */
    function generateQuickSortSteps(arr) {
      const steps = [];
      const array = [...arr]; // å…ƒã®é…åˆ—ã‚’ä¿è­·

      /**
       * ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¨˜éŒ²ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
       */
      function recordStep(type, indices, description) {
        steps.push({
          type,
          array: [...array], // é…åˆ—ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ
          indices: { ...indices },
          description
        });
      }

      /**
       * ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³å‡¦ç†
       */
      function partition(low, high, sortedIndices) {
        const pivot = array[high];

        // ãƒ”ãƒœãƒƒãƒˆé¸æŠã‚’è¨˜éŒ²
        recordStep('pivot', {
          pivot: high,
          sorted: [...sortedIndices],
          comparing: [],
          swapping: []
        }, `ãƒ”ãƒœãƒƒãƒˆ ${pivot} (ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ ${high}) ã‚’é¸æŠ`);

        let i = low - 1;

        for (let j = low; j < high; j++) {
          // æ¯”è¼ƒã‚’è¨˜éŒ²
          recordStep('compare', {
            pivot: high,
            comparing: [j, high],
            sorted: [...sortedIndices],
            swapping: []
          }, `${array[j]} ã¨ãƒ”ãƒœãƒƒãƒˆ ${pivot} ã‚’æ¯”è¼ƒ`);

          if (array[j] <= pivot) {
            i++;
            if (i !== j) {
              // ã‚¹ãƒ¯ãƒƒãƒ—å‰ã®å€¤ã‚’ä¿å­˜
              const temp1 = array[i];
              const temp2 = array[j];

              // å®Ÿéš›ã«ã‚¹ãƒ¯ãƒƒãƒ—
              [array[i], array[j]] = [array[j], array[i]];

              // ã‚¹ãƒ¯ãƒƒãƒ—ã‚’è¨˜éŒ²
              recordStep('swap', {
                swapping: [i, j],
                pivot: high,
                sorted: [...sortedIndices],
                comparing: []
              }, `${temp2} ã¨ ${temp1} ã‚’äº¤æ›`);
            }
          }
        }

        // ãƒ”ãƒœãƒƒãƒˆã‚’æ­£ã—ã„ä½ç½®ã«é…ç½®
        if (i + 1 !== high) {
          const temp1 = array[i + 1];
          const temp2 = array[high];

          [array[i + 1], array[high]] = [array[high], array[i + 1]];

          recordStep('swap', {
            swapping: [i + 1, high],
            sorted: [...sortedIndices],
            pivot: null,
            comparing: []
          }, `ãƒ”ãƒœãƒƒãƒˆ ${temp2} ã‚’æ­£ã—ã„ä½ç½® ${i + 1} ã«é…ç½®`);
        }

        return i + 1;
      }

      /**
       * ã‚¯ã‚¤ãƒƒã‚¯ã‚½ãƒ¼ãƒˆæœ¬ä½“ï¼ˆå†å¸°ï¼‰
       */
      function quickSort(low, high, sortedIndices = []) {
        if (low < high) {
          const pivotIndex = partition(low, high, sortedIndices);

          // ãƒ”ãƒœãƒƒãƒˆã¯ã‚½ãƒ¼ãƒˆæ¸ˆã¿
          sortedIndices.push(pivotIndex);
          recordStep('sorted', {
            sorted: [...sortedIndices],
            pivot: null,
            comparing: [],
            swapping: []
          }, `ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ ${pivotIndex} (å€¤: ${array[pivotIndex]}) ãŒã‚½ãƒ¼ãƒˆå®Œäº†`);

          // å·¦å´ã‚’å†å¸°çš„ã«ã‚½ãƒ¼ãƒˆ
          quickSort(low, pivotIndex - 1, sortedIndices);

          // å³å´ã‚’å†å¸°çš„ã«ã‚½ãƒ¼ãƒˆ
          quickSort(pivotIndex + 1, high, sortedIndices);
        } else if (low === high) {
          // å˜ä¸€è¦ç´ ã¯ã‚½ãƒ¼ãƒˆæ¸ˆã¿
          sortedIndices.push(low);
          recordStep('sorted', {
            sorted: [...sortedIndices],
            pivot: null,
            comparing: [],
            swapping: []
          }, `ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ ${low} (å€¤: ${array[low]}) ãŒã‚½ãƒ¼ãƒˆå®Œäº†`);
        }
      }

      // åˆæœŸçŠ¶æ…‹ã‚’è¨˜éŒ²
      recordStep('initial', {
        sorted: [],
        pivot: null,
        comparing: [],
        swapping: []
      }, 'åˆæœŸçŠ¶æ…‹ - ã‚¯ã‚¤ãƒƒã‚¯ã‚½ãƒ¼ãƒˆã‚’é–‹å§‹ã—ã¾ã™');

      // ã‚½ãƒ¼ãƒˆå®Ÿè¡Œ
      const sortedIndices = [];
      quickSort(0, array.length - 1, sortedIndices);

      // å®Œäº†çŠ¶æ…‹ã‚’è¨˜éŒ²
      recordStep('complete', {
        sorted: array.map((_, i) => i),
        pivot: null,
        comparing: [],
        swapping: []
      }, 'ã‚½ãƒ¼ãƒˆå®Œäº†ï¼');

      return steps;
    }

    // ========================================
    // ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯
    // ========================================

    /**
     * ã‚¯ã‚¤ãƒƒã‚¯ã‚½ãƒ¼ãƒˆã®ã‚¹ãƒ†ãƒƒãƒ—ç®¡ç†ãƒ•ãƒƒã‚¯
     */
    function useQuickSort(arraySize, initialState, customValues) {
      const [sortSteps, setSortSteps] = useState([]);

      /**
       * é…åˆ—ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
       */
      const generateArray = useCallback(() => {
        let arr;

        switch (initialState) {
          case 'random':
            // ãƒ©ãƒ³ãƒ€ãƒ ãª1-100ã®æ•´æ•°
            arr = Array.from({ length: arraySize }, () =>
              Math.floor(Math.random() * 100) + 1
            );
            break;

          case 'reversed':
            // é€†é †ï¼ˆå¤§ãã„é †ï¼‰
            arr = Array.from({ length: arraySize }, (_, i) =>
              arraySize - i
            );
            break;

          case 'nearlySorted':
            // ã»ã¼ã‚½ãƒ¼ãƒˆæ¸ˆã¿ï¼ˆé †åºã®20%ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«å…¥ã‚Œæ›¿ãˆï¼‰
            arr = Array.from({ length: arraySize }, (_, i) => i + 1);
            const swapCount = Math.max(1, Math.floor(arraySize * 0.2));
            for (let i = 0; i < swapCount; i++) {
              const idx1 = Math.floor(Math.random() * arraySize);
              const idx2 = Math.floor(Math.random() * arraySize);
              [arr[idx1], arr[idx2]] = [arr[idx2], arr[idx1]];
            }
            break;

          case 'custom':
            if (customValues) {
              // ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã®æ–‡å­—åˆ—ã‚’ãƒ‘ãƒ¼ã‚¹
              arr = customValues
                .split(',')
                .map(v => parseInt(v.trim(), 10))
                .filter(v => !isNaN(v) && v >= 1 && v <= 100);

              // æœ‰åŠ¹ãªå€¤ãŒ5å€‹æœªæº€ã¾ãŸã¯50å€‹è¶…ã®å ´åˆã¯ãƒ©ãƒ³ãƒ€ãƒ ã«
              if (arr.length < 5 || arr.length > 50) {
                console.warn('ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›ãŒç„¡åŠ¹ã§ã™ã€‚ãƒ©ãƒ³ãƒ€ãƒ é…åˆ—ã‚’ç”Ÿæˆã—ã¾ã™ã€‚');
                arr = Array.from({ length: arraySize }, () =>
                  Math.floor(Math.random() * 100) + 1
                );
              }
            } else {
              // customValuesãŒæœªè¨­å®šã®å ´åˆ
              arr = Array.from({ length: arraySize }, () =>
                Math.floor(Math.random() * 100) + 1
              );
            }
            break;

          default:
            arr = Array.from({ length: arraySize }, () =>
              Math.floor(Math.random() * 100) + 1
            );
        }

        return arr;
      }, [arraySize, initialState, customValues]);

      /**
       * æ–°ã—ã„é…åˆ—ã‚’ç”Ÿæˆã—ã¦ã‚½ãƒ¼ãƒˆã‚¹ãƒ†ãƒƒãƒ—ã‚’ä½œæˆ
       */
      const regenerate = useCallback(() => {
        const arr = generateArray();
        const steps = generateQuickSortSteps(arr);
        setSortSteps(steps);
        return steps.length;
      }, [generateArray]);

      return { sortSteps, regenerate };
    }

    /**
     * ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆãƒ•ãƒƒã‚¯
     */
    function useKeyboardShortcuts(handlers) {
      useEffect(() => {
        function handleKeyDown(e) {
          // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒã‚ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
          if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') {
            return;
          }

          switch (e.key) {
            case ' ':
              e.preventDefault();
              handlers.onPlayPause?.();
              break;
            case 'ArrowLeft':
              e.preventDefault();
              handlers.onStepBackward?.();
              break;
            case 'ArrowRight':
              e.preventDefault();
              handlers.onStepForward?.();
              break;
            case 'Home':
              e.preventDefault();
              handlers.onJumpToStart?.();
              break;
            case 'End':
              e.preventDefault();
              handlers.onJumpToEnd?.();
              break;
            default:
              break;
          }
        }

        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
      }, [handlers]);
    }

    // ========================================
    // ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
    // ========================================

    /**
     * ãƒ˜ãƒƒãƒ€ãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
     */
    function Header({ theme, onThemeToggle }) {
      return (
        <header>
          <div className="brand">
            <div className="logo"></div>
            <span>QuickSort Visualizer</span>
          </div>
          <button
            className="theme-toggle"
            onClick={onThemeToggle}
            aria-label={theme === 'dark' ? 'ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ã«åˆ‡æ›¿' : 'ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡æ›¿'}
          >
            {theme === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸'}
          </button>
        </header>
      );
    }

    /**
     * æ£’ã‚°ãƒ©ãƒ•ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
     */
    function BarChart({ array, indices }) {
      const maxValue = Math.max(...array, 1); // ã‚¼ãƒ­é™¤ç®—ã‚’é˜²ã
      const { pivot, comparing, swapping, sorted } = indices;

      return (
        <div className="bar-chart" role="img" aria-label="ã‚½ãƒ¼ãƒˆçŠ¶æ…‹ã®æ£’ã‚°ãƒ©ãƒ•">
          {array.map((value, index) => {
            // è‰²åˆ†ã‘ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆå„ªå…ˆé †ä½é †ï¼‰
            let colorClass = 'bar-default';

            if (sorted && sorted.includes(index)) {
              colorClass = 'bar-sorted';
            } else if (pivot === index) {
              colorClass = 'bar-pivot';
            } else if (swapping && swapping.includes(index)) {
              colorClass = 'bar-swapping';
            } else if (comparing && comparing.includes(index)) {
              colorClass = 'bar-comparing';
            }

            // é«˜ã•ã‚’ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ã§è¨ˆç®—
            const heightPercent = (value / maxValue) * 100;

            return (
              <div
                key={`${index}-${value}`}
                className={`bar ${colorClass}`}
                style={{
                  height: `${heightPercent}%`,
                  flex: `1 1 ${100 / array.length}%`
                }}
                role="presentation"
              >
                <span className="bar-value">{value}</span>
              </div>
            );
          })}
        </div>
      );
    }

    /**
     * ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
     */
    function Visualizer({ step }) {
      if (!step) {
        return (
          <div className="card visualizer-container">
            <div className="operation-display">
              <p className="empty-message">
                ã€Œæ–°ã—ã„é…åˆ—ã‚’ç”Ÿæˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦é–‹å§‹ã—ã¦ãã ã•ã„
              </p>
            </div>
          </div>
        );
      }

      const { array, indices, description } = step;

      return (
        <div className="card visualizer-container">
          <div className="operation-display">
            <p>{description}</p>
          </div>
          <BarChart array={array} indices={indices} />
        </div>
      );
    }

    /**
     * å†ç”Ÿã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
     */
    function PlaybackControls({
      isPlaying,
      onPlayPause,
      onStepForward,
      onStepBackward,
      onJumpToStart,
      onJumpToEnd,
      currentStep,
      totalSteps,
      playbackSpeed,
      onSpeedChange,
      onSeek,
      disabled
    }) {
      return (
        <div className="card">
          <h2 className="card-title">å†ç”Ÿã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«</h2>

          <div className="control-buttons">
            <button
              className="btn"
              onClick={onJumpToStart}
              disabled={disabled || currentStep === 0}
              title="æœ€åˆã¸ (Home)"
              aria-label="æœ€åˆã¸ã‚¸ãƒ£ãƒ³ãƒ—"
            >
              â®
            </button>

            <button
              className="btn"
              onClick={onStepBackward}
              disabled={disabled || currentStep === 0}
              title="å‰ã¸ (â†)"
              aria-label="1ã‚¹ãƒ†ãƒƒãƒ—æˆ»ã‚‹"
            >
              âª
            </button>

            <button
              className="btn primary"
              onClick={onPlayPause}
              disabled={disabled}
              title={isPlaying ? "ä¸€æ™‚åœæ­¢ (Space)" : "å†ç”Ÿ (Space)"}
              aria-label={isPlaying ? "ä¸€æ™‚åœæ­¢" : "å†ç”Ÿ"}
            >
              {isPlaying ? 'â¸' : 'â–¶'}
            </button>

            <button
              className="btn"
              onClick={onStepForward}
              disabled={disabled || currentStep === totalSteps - 1}
              title="æ¬¡ã¸ (â†’)"
              aria-label="1ã‚¹ãƒ†ãƒƒãƒ—é€²ã‚€"
            >
              â©
            </button>

            <button
              className="btn"
              onClick={onJumpToEnd}
              disabled={disabled || currentStep === totalSteps - 1}
              title="æœ€å¾Œã¸ (End)"
              aria-label="æœ€å¾Œã¸ã‚¸ãƒ£ãƒ³ãƒ—"
            >
              â­
            </button>
          </div>

          <div className="seek-bar">
            <input
              type="range"
              min="0"
              max={Math.max(0, totalSteps - 1)}
              value={currentStep}
              onChange={e => onSeek(parseInt(e.target.value, 10))}
              disabled={disabled}
              aria-label="ã‚·ãƒ¼ã‚¯ãƒãƒ¼"
            />
            <span className="step-counter">
              ã‚¹ãƒ†ãƒƒãƒ— {currentStep + 1} / {totalSteps}
            </span>
          </div>

          <div className="control-group">
            <label htmlFor="speed-select" className="control-label">å†ç”Ÿé€Ÿåº¦</label>
            <select
              id="speed-select"
              value={playbackSpeed}
              onChange={e => onSpeedChange(parseFloat(e.target.value))}
              disabled={disabled}
            >
              <option value="0.25">0.25x (ã‚¹ãƒ­ãƒ¼ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³)</option>
              <option value="0.5">0.5x</option>
              <option value="1">1x (æ¨™æº–)</option>
              <option value="1.5">1.5x</option>
              <option value="2">2x (é«˜é€Ÿ)</option>
            </select>
          </div>
        </div>
      );
    }

    /**
     * ãƒ‡ãƒ¼ã‚¿ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
     */
    function DataControls({
      arraySize,
      onArraySizeChange,
      initialState,
      onInitialStateChange,
      customValues,
      onCustomValuesChange,
      onGenerate,
      disabled
    }) {
      return (
        <div className="card">
          <h2 className="card-title">ãƒ‡ãƒ¼ã‚¿è¨­å®š</h2>

          <div className="control-group">
            <div className="range-display">
              <label htmlFor="array-size" className="control-label">é…åˆ—ã‚µã‚¤ã‚º</label>
              <span className="range-value">{arraySize}</span>
            </div>
            <input
              id="array-size"
              type="range"
              min="5"
              max="50"
              value={arraySize}
              onChange={e => onArraySizeChange(parseInt(e.target.value, 10))}
              disabled={disabled}
            />
          </div>

          <div className="control-group">
            <label htmlFor="initial-state" className="control-label">åˆæœŸçŠ¶æ…‹</label>
            <select
              id="initial-state"
              value={initialState}
              onChange={e => onInitialStateChange(e.target.value)}
              disabled={disabled}
            >
              <option value="random">ãƒ©ãƒ³ãƒ€ãƒ </option>
              <option value="reversed">é€†é †</option>
              <option value="nearlySorted">ã»ã¼ã‚½ãƒ¼ãƒˆæ¸ˆã¿</option>
              <option value="custom">æ‰‹å‹•å…¥åŠ›</option>
            </select>
          </div>

          {initialState === 'custom' && (
            <div className="control-group">
              <label htmlFor="custom-input" className="control-label">
                å€¤ã‚’å…¥åŠ› (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)
              </label>
              <input
                id="custom-input"
                type="text"
                placeholder="ä¾‹: 5,3,8,1,9,2,7"
                value={customValues || ''}
                onChange={e => onCustomValuesChange(e.target.value)}
                disabled={disabled}
              />
              <p className="hint">1ã€œ100ã®æ•´æ•°ã‚’5ã€œ50å€‹å…¥åŠ›ã—ã¦ãã ã•ã„</p>
            </div>
          )}

          <button
            className="btn primary"
            onClick={onGenerate}
            disabled={disabled}
            style={{ width: '100%', marginTop: '8px' }}
          >
            æ–°ã—ã„é…åˆ—ã‚’ç”Ÿæˆ
          </button>
        </div>
      );
    }

    /**
     * ãƒ•ãƒƒã‚¿ãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
     */
    function Footer({ stats }) {
      return (
        <footer>
          <div className="stat-item">
            <span className="stat-label">æ¯”è¼ƒ:</span>
            <span className="stat-value">{stats.comparisons}å›</span>
          </div>
          <div className="stat-item">
            <span className="stat-label">ã‚¹ãƒ¯ãƒƒãƒ—:</span>
            <span className="stat-value">{stats.swaps}å›</span>
          </div>
          <div className="stat-item">
            <span className="stat-label">ç·ã‚¹ãƒ†ãƒƒãƒ—:</span>
            <span className="stat-value">{stats.totalSteps}</span>
          </div>
        </footer>
      );
    }

    // ========================================
    // ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
    // ========================================

    function App() {
      // çŠ¶æ…‹ç®¡ç†
      const [theme, setTheme] = useState('dark');
      const [arraySize, setArraySize] = useState(20);
      const [initialState, setInitialState] = useState('random');
      const [customValues, setCustomValues] = useState('');
      const [currentStepIndex, setCurrentStepIndex] = useState(0);
      const [isPlaying, setIsPlaying] = useState(false);
      const [playbackSpeed, setPlaybackSpeed] = useState(1);

      // ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯
      const { sortSteps, regenerate } = useQuickSort(arraySize, initialState, customValues);

      // ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—
      const currentStep = sortSteps[currentStepIndex] || null;

      // çµ±è¨ˆæƒ…å ±
      const stats = useMemo(() => ({
        totalSteps: sortSteps.length,
        comparisons: sortSteps.filter(s => s.type === 'compare').length,
        swaps: sortSteps.filter(s => s.type === 'swap').length
      }), [sortSteps]);

      // ãƒ†ãƒ¼ãƒåˆ‡æ›¿
      const handleThemeToggle = useCallback(() => {
        setTheme(prev => prev === 'dark' ? 'light' : 'dark');
      }, []);

      // ãƒ†ãƒ¼ãƒã‚’bodyã«é©ç”¨
      useEffect(() => {
        document.body.className = theme;
      }, [theme]);

      // é…åˆ—ç”Ÿæˆ
      const handleGenerate = useCallback(() => {
        setIsPlaying(false);
        setCurrentStepIndex(0);
        regenerate();
      }, [regenerate]);

      // å†ç”Ÿ/ä¸€æ™‚åœæ­¢
      const handlePlayPause = useCallback(() => {
        setIsPlaying(prev => !prev);
      }, []);

      // ã‚¹ãƒ†ãƒƒãƒ—ç§»å‹•
      const handleStepForward = useCallback(() => {
        setCurrentStepIndex(prev => Math.min(prev + 1, sortSteps.length - 1));
      }, [sortSteps.length]);

      const handleStepBackward = useCallback(() => {
        setCurrentStepIndex(prev => Math.max(prev - 1, 0));
      }, []);

      const handleJumpToStart = useCallback(() => {
        setCurrentStepIndex(0);
        setIsPlaying(false);
      }, []);

      const handleJumpToEnd = useCallback(() => {
        setCurrentStepIndex(sortSteps.length - 1);
        setIsPlaying(false);
      }, [sortSteps.length]);

      const handleSeek = useCallback((index) => {
        setCurrentStepIndex(index);
      }, []);

      // è‡ªå‹•å†ç”Ÿãƒ­ã‚¸ãƒƒã‚¯
      useEffect(() => {
        if (!isPlaying || sortSteps.length === 0) return;

        const interval = 1000 / playbackSpeed; // é€Ÿåº¦ã«å¿œã˜ãŸé–“éš”

        const timer = setInterval(() => {
          setCurrentStepIndex(prev => {
            const next = prev + 1;
            if (next >= sortSteps.length) {
              setIsPlaying(false); // è‡ªå‹•åœæ­¢
              return prev;
            }
            return next;
          });
        }, interval);

        return () => clearInterval(timer);
      }, [isPlaying, playbackSpeed, sortSteps.length]);

      // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
      useKeyboardShortcuts({
        onPlayPause: handlePlayPause,
        onStepForward: handleStepForward,
        onStepBackward: handleStepBackward,
        onJumpToStart: handleJumpToStart,
        onJumpToEnd: handleJumpToEnd
      });

      const disabled = sortSteps.length === 0;

      return (
        <>
          <Header theme={theme} onThemeToggle={handleThemeToggle} />

          <main>
            <div className="container">
              <Visualizer step={currentStep} />

              <div className="controls-grid">
                <PlaybackControls
                  isPlaying={isPlaying}
                  onPlayPause={handlePlayPause}
                  onStepForward={handleStepForward}
                  onStepBackward={handleStepBackward}
                  onJumpToStart={handleJumpToStart}
                  onJumpToEnd={handleJumpToEnd}
                  currentStep={currentStepIndex}
                  totalSteps={sortSteps.length}
                  playbackSpeed={playbackSpeed}
                  onSpeedChange={setPlaybackSpeed}
                  onSeek={handleSeek}
                  disabled={disabled}
                />

                <DataControls
                  arraySize={arraySize}
                  onArraySizeChange={setArraySize}
                  initialState={initialState}
                  onInitialStateChange={setInitialState}
                  customValues={customValues}
                  onCustomValuesChange={setCustomValues}
                  onGenerate={handleGenerate}
                  disabled={isPlaying}
                />
              </div>
            </div>
          </main>

          <Footer stats={stats} />
        </>
      );
    }

    // ========================================
    // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    // ========================================

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
